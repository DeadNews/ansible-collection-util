---
# Upgrade Debian-based OS

- name: Update cache
  ansible.builtin.apt:
    cache_valid_time: 300

- name: Get upgradable list
  ansible.builtin.command: apt list --upgradable
  register: aptup_list
  changed_when: false

- name: Print upgradable list
  ansible.builtin.debug:
    var: aptup_list.stdout

- name: Attempt to correct a system with broken dependencies in place
  ansible.builtin.apt:
    state: fixed
  register: aptup_fixed

- name: Show fix-broken result
  ansible.builtin.debug:
    var: aptup_dist.stdout
  when:
    - aptup_show_stdout

- name: Upgrade the OS (apt dist-upgrade)
  ansible.builtin.apt:
    upgrade: dist
    cache_valid_time: 7200
    dpkg_options: force-confold,force-confdef
  register: aptup_dist
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Show dist-upgrade result
  ansible.builtin.debug:
    var: aptup_dist.stdout
  when:
    - aptup_show_stdout
