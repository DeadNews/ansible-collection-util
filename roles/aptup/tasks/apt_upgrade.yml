---
# Upgrade Debian-based OS

- name: Update cache
  ansible.builtin.apt:
    cache_valid_time: 300

- name: Get upgradable list
  ansible.builtin.command: apt list --upgradable
  register: aptup_list
  changed_when: false

- name: Print upgradable list
  ansible.builtin.debug:
    var: aptup_list.stdout_lines

- name: Attempt to correct a system with broken dependencies in place
  ansible.builtin.apt:
    state: fixed

- name: Upgrade the OS (apt dist-upgrade)
  ansible.builtin.apt:
    upgrade: dist
    cache_valid_time: 7200
    dpkg_options: force-confold,force-confdef
  environment:
    DEBIAN_FRONTEND: noninteractive
  register: aptup_dist
  failed_when:
    - aptup_dist.rc is defined
    - aptup_dist.rc != 0

- name: Show Upgrade errors
  ansible.builtin.fail:
    msg: aptup_dist.stderr_lines
  when:
    - aptup_dist.rc is defined
    - aptup_dist.rc != 0
